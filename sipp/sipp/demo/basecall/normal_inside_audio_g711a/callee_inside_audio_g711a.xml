<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE scenario SYSTEM "sipp.dtd">

<!--用于模拟局内被叫侧用户的正常业务流程
		媒体类型：PCMU
		呼叫挂机：主叫方-->
<!--脚本编写时间：2015-11-11 17:15 by：王伟-->
<!--编辑确认时间：2016-01-04 11:07 by：王伟
		编辑内容：1.梳理格式，增加注释内容
							2.调整统计response定时器间隔
							3.增加超时时长，保证超时失败-->
<!--脚本归整时间：2016-4-25
		归整内容：1.增加主叫未挂机，BYE接收超时主动发BYE的流程
				  2.修改正则表达式内容
				  3.删除多余的正则提取参数caller_media_port
				  4.响应100和180之间的时间间隔设置为20ms-->					
<scenario name="callee_inner_normal_noprint">
	
<recv request="INVITE">
<!--参数caller_num、callee_num和caller_tag用于主叫未挂机，BYE接收超时主动发BYE的流程-->
	<action>
		<ereg regexp="<sip:(.*)@(.*)>;tag=(.*)"
			  search_in="hdr"
			  header="From: "
			  check_it="true"
			  assign_to="junk,caller_num,domain,caller_tag" />	
		<ereg regexp="<sip:(.*)@.*>"
			  search_in="hdr"
			  header="To: "
			  check_it="true"
			  assign_to="junk,callee_num" />	  
	</action>
</recv>
		
<!--增加间隔100ms，避免偶现系统不发送100响应的问题-->
<pause hide="true" milliseconds="100"/>  
	
<send>
	<![CDATA[
	SIP/2.0 100 Trying
	[last_Via:]
	[last_From:]
	[last_To:]
	[last_Call-ID:]
	[last_CSeq:]
	Contact: <sip:[local_ip]:[local_port];transport=[transport]>
	Content-Length: 0
	]]>
	</send>

<!--增加间隔20ms，避免偶现系统不发送180响应的问题-->
<pause hide="true" milliseconds="20"/> 
 
<send>
	<![CDATA[
	SIP/2.0 180 Ringing
	[last_Via:]
	[last_From:]
	[last_To:];tag=[call_number]
	[last_Call-ID:]
	[last_CSeq:]
	Contact: <sip:[local_ip]:[local_port];transport=[transport]>
	Content-Length: 0
	]]>
</send>

<!--设置发送200后等待ACK的重传周期为1秒，如果1秒内收不到ACK则进行200的重传-->
<send retrans="1000" start_rtd="ack">
	<![CDATA[
	SIP/2.0 200 OK 
	[last_Via:]
	[last_From:]
	[last_To:];tag=[call_number]
	[last_Call-ID:]
	[last_CSeq:]
	Session-Expires: 130;refresher=uas
	Contact:<sip:[local_ip]:[local_port];transport=[transport]>
	Content-Type: application/sdp
	Content-Length: [len]
			
	v=0
	o=user1 53655765 2353687637 IN IP[local_ip_type] [local_ip]
	s=-
	c=IN IP[media_ip_type] [media_ip]
	t=0 0
	m=audio [media_port] RTP/AVP 8
	a=rtpmap:8 PCMA/8000
	a=ptime: 20
	]]>
</send>
	
	<!--设置等待ACK的超时定时器为5秒，如果30秒内收不到ACK则呼叫超时失败而结束-->	
<recv request="ACK" rtd="ack" timeout="30000" />
 
<nop hide="true">
	<action>
		<exec play_pcap_audio="pcap/g711a.pcap"/> 
	</action>
</nop>

<recv request="BYE" timeout="30000" ontimeout="send_bye"/>	
<send next="END">
	<![CDATA[
	SIP/2.0 200 OK
	[last_Via:]
	[last_From:]
	[last_To:]
	[last_Call-ID:]
	[last_CSeq:]
	Contact: <sip:[local_ip]:[local_port];transport=[transport]>
	Content-Length: 0
	]]>
</send>
	
<!--主叫未挂机，BYE接收超时,被叫主动发BYE-->	
<label id="send_bye"/> 
<send start_rtd="bye">
    <![CDATA[
	BYE sip:[$caller_num]@[local_ip]:[local_port] SIP/2.0
    Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
    From: "[$caller_num]" <sip:[$caller_num]@[local_ip]>;tag=[call_number]
    To: "[$callee_num]"<sip:[$callee_num]@[local_ip]>;tag=[$caller_tag]
    Call-ID: [call_id]
    CSeq: 2 BYE
    Max-Forwards: 70
    Subject: normal call scenario by wangwei
    Content-Length: 0
	]]>
</send>

<recv response="200" rtd="bye">
</recv> 
 
<label id="END"/>

<Reference variables="junk,domain" />

<!-- definition of the response time repartition table (unit is ms)-->
<ResponseTimeRepartition value="50, 200"/>

<!-- definition of the call length repartition table (unit is ms)-->
<CallLengthRepartition value="500, 1000, 10000"/>

</scenario>